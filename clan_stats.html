<!DOCTYPE html>
<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.3.1/darkly/bootstrap.min.css" rel="stylesheet">
    <script>
    var bungieAPIkey = "0a11942f318647978979f13ad8aa53ee";
    var clan = {};
        clan.memberIds = [];
        clan.memberCount = 0;
        clan.membersFetched = 0;
        clan.memberName = {};
        clan.retryCounter = {};
        clan.unresolvedMemberNames = [];
        clan.membersWithLunasHowl = 0;
        clan.membersWithNotForgotten = 0;
        clan.membersWithMountaintop = 0;
        clan.membersWithRecluse = 0;
        clan.membersWithRedrixBroadsword = 0;
        clan.membersWithLoadedQuestion = 0;
        clan.membersWithOxygen = 0;
        clan.membersWithWendigo = 0;
        clan.membersWithBreakneck = 0;
        clan.membersWithDelirium = 0;
        clan.membersWithHush = 0;
        clan.membersWithOneThousandVoices = 0;
        clan.membersWithAnarchy = 0;
        clan.membersWithRevoker = 0;
        clan.membersWithMalfeasance = 0;
        clan.membersWithLastWishSparrow = 0;
        clan.membersWithTarrabah = 0;
        clan.membersWithAlwaysOnTime = 0;
        clan.membersWithThorn = 0;
        clan.membersWithTruth = 0;
        clan.membersWithTheLastWord = 0;
        clan.membersWithIzanagisBurden = 0;
        clan.membersWithOutbreakPerfected = 0;
        clan.membersWithScrap = 0;
$(document).ready(function() {
    $("#tablink1").click(function() {
        openTab("tablink1", "t1")
    });
    $("#tablink2").click(function() {
        openTab("tablink2", "t2")
    });
    $("#tablink1").click();
    $.ajax({
        url: "https://www.bungie.net/Platform/GroupV2/1801684/Members/",
        headers: {
            "X-API-KEY": bungieAPIkey
        },
        method: "GET"
    }).done(function(data) {
        if (!data.Response) {
            $("#claninfo").html("API down?");
            return
        }
        $.each(data.Response.results, function(index, value) {
            clan.memberIds.push(value.destinyUserInfo.membershipId);
            clan.retryCounter[value.destinyUserInfo.membershipId] = 0;
            clan.memberName[value.destinyUserInfo.membershipId] = value.destinyUserInfo.displayName
        });
        clan.memberCount = clan.memberIds.length;
        $.each(clan.memberIds, function(index, memberid) {
            getAccountData(memberid);
            checkForSpecialAchievements(memberid)
        })
    })
});
$(document).ajaxStop(function() {
    $(".sk-folding-cube").hide();
    if (clan.unresolvedMemberNames.length > 0) $(".cubelegend").append("<br><small>(unable to fetch " + clan.unresolvedMemberNames.join(", ") + ")</small>")
});

function getAccountData(memberid) {
    clan.retryCounter[memberid] = clan.retryCounter[memberid] + 1;
    if (clan.retryCounter[memberid] > 4) {
        clan.unresolvedMemberNames.push(clan.memberName[memberid]);
        return
    }
    $.ajax({
        url: "https://www.bungie.net/Platform/Destiny2/2/Account/" + memberid + "/Character/0/Stats/",
        headers: {
            "X-API-KEY": bungieAPIkey
        },
        data: {
            groups: "1,3",
            modes: "4,5,7,10,12,15,19,25,31,32,37,38,39,41,42,43,44,45,48,49,50,51,52,53,5,4,55,56,57,59,60,61,62,64,65,68,69,70,71,72,73,74"
        },
        method: "GET"
    }).done(function(data) {
        if (data.ErrorCode > 1 || !data.Response) getAccountData(memberid);
        else {
            clan.membersFetched = clan.membersFetched +
                1;
            outputClanData(clan)
        }
    });
    return
}

function checkForSpecialAchievements(memberid) {
    var aquiredCollectibleStateValues = [0, 8, 16, 64, 80];
    $.ajax({
        url: "https://www.bungie.net/Platform/Destiny2/2/Profile/" + memberid + "/?components=800,900",
        headers: {
            "X-API-KEY": bungieAPIkey
        },
        method: "GET"
    }).done(function(data) {
        if (data.ErrorCode > 1 || !data.Response || typeof data.Response.profileCollectibles.data === "undefined") {
            clan.retryCounter[memberid]++;
            if (clan.retryCounter[memberid] > 4) {
                clan.unresolvedMemberNames.push(clan.memberName[memberid]);
                return
            }
            checkForSpecialAchievements(memberid)
        } else {
            clan.membersWithLunasHowl = clan.membersWithLunasHowl + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[3260604718].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithNotForgotten = clan.membersWithNotForgotten + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[3260604717].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithRecluse = clan.membersWithRecluse + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[2335550020].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithMountaintop = clan.membersWithMountaintop + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[4047371119].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            
            clan.membersWithRevoker = clan.membersWithRevoker + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[3066162258].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithRB = clan.membersWithRB + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[1111219481].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithLQ = clan.membersWithLQ + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[3810740723].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithOXY = clan.membersWithOXY + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[543982652].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithWEN = clan.membersWithWEN + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[3830703103].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithBN = clan.membersWithBN + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[1666039008].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithDEL = clan.membersWithDEL + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[1639266456].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithOneKay = clan.membersWithOneKay + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[199171385].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithAN = clan.membersWithAN + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[2220014607].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithMalf = clan.membersWithMalf + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[1660030045].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithHush = clan.membersWithHush + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[1670904512].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithTAR = clan.membersWithTAR + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[2329697053].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithAOT = clan.membersWithAOT + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[1903459810].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithTH = clan.membersWithTH + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[4009683574].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithTR = clan.membersWithTR + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[1763840761].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithTLW = clan.membersWithTLW + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[3074058273].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithIB = clan.membersWithIB + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[24541428].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithOP = clan.membersWithOP + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[2500286745].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            clan.membersWithScrap = clan.membersWithScrap + (jQuery.inArray(data.Response.profileCollectibles.data.collectibles[1840126886].state, aquiredCollectibleStateValues) !== -1 ? 1 : 0);
            
            $.each(data.Response.characterCollectibles.data, function(index, value) {
                if ((jQuery.inArray(value.collectibles[1469913804].state, aquiredCollectibleStateValues) !== -1)) {
                    clan.membersWithLWS = clan.membersWithLWS + 1;
                    return false
                }
            });
            outputClanData(clan)
        }
    });
    return
}

function getDescendantProp(obj, desc) {
    var arr = desc.split(".");
    while (arr.length && (obj = obj[arr.shift()]));
    return obj
}

function outputClanData(clanobject) {
    $("#LunasHowl").html(clanobject.membersWithLunasHowl);
    $("#NotForgotten").html(clanobject.membersWithNotForgotten);
    $("#Mountaintop").html(clanobject.membersWithMountaintop);
    $("#membercounter").html(clanobject.membersFetched + "/" + clanobject.memberCount);
    return
}

function openTab(btn, tabName) {
    $(".tabcontent").hide();
    $(".tablinks").removeClass("active");
    $("#" + tabName).show();
    $("#" + btn).addClass("active")
};
</script>
</head>
<body>
    <div class="tab" id="claninfo">
    	<button id="tablink1" class="tablinks btn btn-success">Pinnacles </button>
    </div>
    <div><span id="membercounter"></span> members</div>
    <div id="t1" class="tabcontent">
        <div class="table-sm">
            <table class="table table-sm">
                <tbody>
                   <tr>
                        <th style="width: 6%" scope="row" class="align-middle text-center"><img src="https://bungie.net/common/destiny2_content/icons/ca86c130898a90ed19a0a317df8ab389.jpg" width="50" height="50"></th>
                        <td style="width: 12%" class="align-middle"><a href="http://light.gg/i/BIotCQ/" target= "_blank">Luna&#39;s Howl</a></td>
                        <td style="width: 20%" class="align-middle">Legendary | Energy | Hand Cannon</td>
                        <td style="width: 8%" class="align-middle"><span class="text-danger">SOLAR</span></td>
                        <td style="width: 20%" class="align-middle">
                        	<img style="list-style:none;float: left;padding-left: 0;margin-right: 10px " src="https://bungie.net/common/destiny2_content/icons/90c4f7f35c9d24f4add016722a78404e.png" width="30" height="30">
                        	<img style="list-style:none;float: left;padding-left: 0;margin-right: 10px" src="https://bungie.net/common/destiny2_content/icons/7cadd68b66ffd3bbedc09aa9c7ba6e03.png" width="30" height="30">
                        	<img style="list-style:none;float: left;padding-left: 0;margin-right: 10px" src="https://bungie.net/common/destiny2_content/icons/d316be9e70844427e69034b0f06bec75.png" width="30" height="30">
                        	<img style="list-style:none;float: left;padding-left: 0;margin-right: 10px" src="https://bungie.net/common/destiny2_content/icons/49958f356ea1df930888d15fe6539fe1.png" width="30" height="30">
                        	<img style="list-style:none;float: left;padding-left: 0;margin-right: 10px" src="https://bungie.net/common/destiny2_content/icons/84ba8155221bbd2e36ffaa9ad977f5ab.png" width="30" height="30">
                       	</td>
                        <td style="width: 15%" id="LunasHowl" class="align-middle text-left"></td>
                    </tr>
                    <tr>
                        <th scope="row" class="align-middle text-center"><img src="https://bungie.net/common/destiny2_content/icons/5098b108ad602dc6f003a332e9f74c27.jpg" width="50" height="50"></th>
                        <td class="align-middle"><a href="http://light.gg/i/B4otCQ/" target= "_blank">Not Forgotten</a></td>
                        <td class="align-middle">Legendary | Energy | Hand Cannon</td>
						<td class="align-middle"><span class="text-danger">SOLAR</span></td>
                        <td class="align-middle">
                        	<img style="list-style:none;float: left;padding-left: 0;margin-right: 10px" src="https://bungie.net/common/destiny2_content/icons/90c4f7f35c9d24f4add016722a78404e.png" width="30" height="30">
                        	<img style="list-style:none;float: left;padding-left: 0;margin-right: 10px" src="https://bungie.net/common/destiny2_content/icons/151465ba86df34438248aad2248cce32.png" width="30" height="30">
                        	<img style="list-style:none;float: left;padding-left: 0;margin-right: 10px" src="https://bungie.net/common/destiny2_content/icons/05e357cd152eb0f665ee986aaa3edc56.png" width="30" height="30">
                        	<img style="list-style:none;float: left;padding-left: 0;margin-right: 10px" src="https://bungie.net/common/destiny2_content/icons/49958f356ea1df930888d15fe6539fe1.png" width="30" height="30">
                        	<img style="list-style:none;float: left;padding-left: 0;margin-right: 10px" src="https://bungie.net/common/destiny2_content/icons/84ba8155221bbd2e36ffaa9ad977f5ab.png" width="30" height="30">
                       	</td>
                        <td id="NotForgotten" class="align-middle text-left"></td>
                    </tr>
                    <tr>
                        <th scope="row" class="align-middle text-center"><img src="https://bungie.net/common/destiny2_content/icons/b372c65f81ad2d49196a6cec4e07704d.jpg" width="50" height="50"></th>
                        <td class="align-middle"><a href="http://light.gg/i/GbAG7g/" target= "_blank">The Mountaintop</a></td>
                        <td class="align-middle">Legendary | Kinetic | Grenade Launcher</td>
                        <td class="align-middle"><span class="text-muted">KINETIC</span></td>
                        <td class="align-middle">
                        	<div>
                        		<ul style="list-style:none;float: left;padding-left: 0;margin-right: 10px;margin-top: 0.6em">
                        			<li><img src="https://bungie.net/common/destiny2_content/icons/530b400d5cec3bf6aca7c5efc46fea20.png" width="30" height="30"></li>
                        		</ul>
                        		<ul style="list-style:none;float: left;padding-left: 0;margin-right: 10px;margin-top: 0.6em">
                        			<li><img src="https://bungie.net/common/destiny2_content/icons/823b8ae4f48bca3bb5586167c1666781.png" width="30" height="30"><li>
                        			<li><img src="https://bungie.net/common/destiny2_content/icons/402765b86ff7b1d97078ac43d5ca39ad.png" width="30" height="30"><li>
                        		</ul>
                        		<ul style="list-style:none;float: left;padding-left: 0;margin-right: 10px;margin-top: 0.6em">
                        			<li><img src="https://bungie.net/common/destiny2_content/icons/c733f59957e33024af80e648729321ad.png" width="30" height="30"></li>
                        			<li><img src="https://bungie.net/common/destiny2_content/icons/e792675af3774d031a5d30d3824d6e27.png" width="30" height="30"></li>
                        		</ul>
                        		<ul style="list-style:none;float: left;padding-left: 0;margin-right: 10px;margin-top: 0.6em">
                        			<li><img src="https://bungie.net/common/destiny2_content/icons/cd4bc691a022136dc149e56ff4e04bf4.png" width="30" height="30"></li>
                        		</ul>
                        		<ul style="list-style:none;float: left;padding-left: 0;margin-right: 10px;margin-top: 0.6em">
                        			<li><img src="https://bungie.net/common/destiny2_content/icons/22a38b81cb2ec0fe9811b5440a52b223.png" width="30" height="30"></li>
                        		</ul>
                        	</div>
                       	</td>
                        <td id="Mountaintop" class="align-middle text-left"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>

</html>
